<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" content="text/html" http-equiv="Content-Type" />
		<meta content="A Scramble checker" name="description" />
		<title>Bramble</title>
		<link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/sidenotes.css" />
 		<link rel="stylesheet" type="text/css" href="css/shCore.css" />
		<link rel="stylesheet" type="text/css" href="css/shThemeSidenotes.css" />
		<style type="text/css">.syntaxhighlighter{overflow:hidden !important;}</style>
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/xregexp-min.js"></script>
		<script type="text/javascript" src="js/shCore.js"></script>
		<script type="text/javascript" src="js/shBrushClojure.js"></script>
	</head>
	<body>
		<div class="gridlayout">
			<div class="box header">
				<h1 class="project-name">yvern.scramble.api</h1>
				<a class="toc-link" href="index.html">table of contents</a>
			</div>
			<div class="box section">
				<p>defines the http server and the api that uses the core scramble logic.   also hosts the webapp that calls the api.</p>
			</div>
			<div class="box section">
				<pre class="brush: clojure">(ns yvern.scramble.api
  (:require [yvern.scramble.core :refer [scramble?]]
            [yvern.scramble.pages :refer [index app]]
            [muuntaja.middleware :refer [wrap-format]]
            [org.httpkit.server :refer [run-server server-status server-port server-stop!]]
            [malli.core :as m]
            [malli.error :as me])
  (:gen-class))</pre>
			</div>
						<div class="box section">
				
			</div>
			<div class="box section">
				<pre class="brush: clojure">(def stop server-stop!)
(def port server-port)
(def status server-status)</pre>
			</div>
						<div class="box section">
				<p>malli schema for a valid scramble play.</p>
			</div>
			<div class="box section">
				<pre class="brush: clojure">(def scramble-play
  [:map {:registry {::valid-text [:and :string [:re &quot;^[a-z]+\$&quot;]]}}
     [:letters ::valid-text]
     [:word ::valid-text]])</pre>
			</div>
						<div class="box section">
				
			</div>
			<div class="box section">
				<pre class="brush: clojure">(def valid? (m/validator scramble-play))</pre>
			</div>
						<div class="box section">
				
			</div>
			<div class="box section">
				<pre class="brush: clojure">(def explanation (m/explainer scramble-play))</pre>
			</div>
						<div class="box section">
				<p>body handler that given a valid scramble play, checks its result.  on invalid one returns an explanation as from malli.</p>
			</div>
			<div class="box section">
				<pre class="brush: clojure">(defn scramble-handler
  [body]
  (if (valid? body)
    {:status 200
     :body (assoc body :scramble? (scramble? body))}
    {:status 400
     :body  (assoc body :errors (me/humanize (explanation body)))}))</pre>
			</div>
						<div class="box section">
				<p>basic router that handles the 2 known endpoints, hosting the spa and the api.</p>
			</div>
			<div class="box section">
				<pre class="brush: clojure">(defn router
  [{:keys [:request-method :uri] :as req}]
  (case [request-method uri]
    [:get &quot;/&quot;] {:body (index (app)) :status 200}
    [:post &quot;/api&quot;] ((wrap-format (comp (memoize scramble-handler) :body-params)) req)
    {:body &quot;Not Found&quot; :status 404}))</pre>
			</div>
						<div class="box section">
				<p>starts the server on given port, and returns the server object, that can be checked on or stopped.</p>
			</div>
			<div class="box section">
				<pre class="brush: clojure">(defn start
  [port']
  (run-server #'router {:port port' :legacy-return-value? false}))</pre>
			</div>
						<div class="box section">
				<p>entrypoint for the server application, that runs on port given as first and only argument, or 8080 by default.  blocks, but can be gracefully halted by entering a newline (enter) on the terminal its running.</p>
			</div>
			<div class="box section">
				<pre class="brush: clojure">(defn -main
  [&amp; args]
  (let [port' (or (some-&gt; args first Integer/parseInt) 8080)
        svr (start port')]
    (println &quot;server&quot; (status svr) &quot;on:&quot; (str &quot;http://localhost:&quot; (port svr)))
    (read-line)
    @(stop svr)
    (println &quot;server&quot; (status svr))))</pre>
			</div>
						<div class="box section">
				
			</div>
			<div class="box section">
				<pre class="brush: clojure">(comment
  (def svr (start 8080))
  (clojure.java.browse/browse-url (str &quot;http://localhost:&quot; (port svr)))
  @(stop svr))</pre>
			</div>
			
			<div class="box footer">
				Generated by <a href="https://github.com/captain-porcelain/sidenotes">Sidenotes</a>.
				&nbsp;&nbsp;
				Syntax highlighting provided by Alex Gorbatchev's <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a>
			</div>
		</div>
		<script type="text/javascript" src="js/app.js"></script>
	</body>
</html>
